<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produtividade</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --clt: #0284c7; --pj: #7c3aed; --bg: #f8fafc; --nav: #1e293b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; color: #1e293b; }

        /* NAVBAR SaaS EVOLU√çDA */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--nav); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        
        .nav-left { display: flex; align-items: center; gap: 40px; }
        .brand { line-height: 1; cursor: pointer; }
        .brand .small { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; display: block; margin-bottom: 2px; }
        .brand .big { font-size: 1.3rem; font-weight: 800; letter-spacing: -1px; color: white; }
        .brand .big span { color: var(--primary); }

        .nav-tools { display: flex; align-items: center; gap: 15px; background: #334155; padding: 8px 15px; border-radius: 10px; border: 1px solid #475569; }
        .nav-tools select, .nav-tools input { background: transparent; border: none; color: white; font-size: 0.85rem; font-weight: 600; outline: none; cursor: pointer; }
        .nav-tools option { background: var(--nav); color: white; }

        .btn-import { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .btn-import:hover { background: #be123c; transform: translateY(-1px); }

        .user-section { display: flex; align-items: center; gap: 15px; border-left: 1px solid #334155; padding-left: 20px; }
        .logout-link { color: #f87171; text-decoration: none; font-size: 0.75rem; font-weight: 700; cursor: pointer; }

        /* CONTE√öDO */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* PAINEL DE KPI (ESTILO COMPACTO) */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 18px; border-radius: 12px; border-left: 5px solid #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-card.active { border-left-color: var(--primary); }
        .kpi-label { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .kpi-value { font-size: 1.4rem; font-weight: 800; color: #1e293b; }

        /* PAINEL DE PERFORMANCE DO TIME (DIA) */
        .daily-focus { background: #1e293b; color: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .daily-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; }
        .daily-stat .label { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
        .daily-stat .value { font-size: 1.3rem; font-weight: 800; display: block; margin-top: 4px; }

        /* TABELA DE DADOS */
        .table-wrap { background: white; border-radius: 15px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
        tr:nth-child(even) { background: #fbfcfe; }
        
        .divider-row { background: #334155 !important; color: white; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <div class="brand" onclick="location.reload()">
            <span class="small">controle de</span>
            <div class="big">PRODUTIVIDADE<span>.</span></div>
        </div>

        <div class="nav-tools">
            <select id="view-selector" onchange="alternarVisao()">
                <option value="dia">Vis√£o: Dia Ativo</option>
                <option value="semana">Relat√≥rio: Semanal</option>
                <option value="mes">Relat√≥rio: Mensal</option>
            </select>
            <div style="width:1px; height:20px; background:#475569;"></div>
            <input type="month" id="filtro-mes" onchange="carregarDados()">
        </div>
    </div>

    <div class="nav-right">
        <button class="btn-import" onclick="document.getElementById('excel-files').click()">üì• Importar Planilhas</button>
        <input type="file" id="excel-files" accept=".xlsx" multiple class="hidden" onchange="importarArquivos()">
        
        <div class="user-section">
            <div style="text-align: right">
                <span style="font-size: 0.85rem; font-weight: 700; display: block;" id="user-name">Patr√≠cia</span>
                <span class="logout-link" onclick="logout()">Sair do Sistema</span>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    
    <div class="kpi-row">
        <div class="kpi-card active"><div class="kpi-label">Produ√ß√£o Total (M√™s)</div><div class="kpi-value" id="kpi-total-mes">0</div></div>
        <div class="kpi-card"><div class="kpi-label">M√©dia CLT (M√™s)</div><div class="kpi-value" style="color:var(--clt)" id="kpi-media-clt">0</div></div>
        <div class="kpi-card"><div class="kpi-label">M√©dia PJ (M√™s)</div><div class="kpi-value" style="color:var(--pj)" id="kpi-media-pj">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Assistente por Dia</div><div class="kpi-value" id="kpi-media-as-dia">0</div></div>
    </div>

    <div id="area-dia" class="daily-focus">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.1rem;">üìå Performance do Time: <span id="label-dia-foco" style="color:var(--primary)">-</span></h2>
            <span id="label-headcount" style="font-size:0.8rem; font-weight:600; background:#334155; padding:5px 12px; border-radius:20px;">0 Assistentes</span>
        </div>
        <div class="daily-grid">
            <div class="daily-stat"><span class="label">Total Geral</span><span class="value" id="d-total">0</span></div>
            <div class="daily-stat"><span class="label">M√©dia Geral</span><span class="value" id="d-media">0</span></div>
            <div class="daily-stat"><span class="label">Total CLT</span><span class="value" style="color:var(--clt)" id="d-clt">0</span></div>
            <div class="daily-stat"><span class="label">Total PJ</span><span class="value" style="color:var(--pj)" id="d-pj">0</span></div>
            <div class="daily-stat"><span class="label">FIFO</span><span class="value" id="d-fifo">0</span></div>
            <div class="daily-stat"><span class="label">Gradual Total</span><span class="value" id="d-gt">0</span></div>
        </div>
    </div>

    <div class="table-wrap">
        <table id="main-table">
            <thead>
                <tr id="table-header">
                    <th>Assistente</th>
                    <th style="color:var(--primary)">Produ√ß√£o</th>
                    <th>Acum. Semana</th>
                    <th>Acum. M√™s</th>
                    <th>M√©dia Semana</th>
                    <th>M√©dia M√™s</th>
                    <th>Atingimento</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    let dadosGlobais = [], metasGlobais = [];

    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if(!sessao) window.location.href = 'index.html';
    document.getElementById('user-name').innerText = sessao.nome;
    document.getElementById('filtro-mes').value = new Date().toISOString().substring(0,7);

    function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }

    async function importarArquivos() {
        const files = document.getElementById('excel-files').files;
        for(let file of files) {
            const fn = file.name.replace('.xlsx', '');
            if(!/^\d{8}$/.test(fn)) continue;
            const dr = `${fn.substring(4,8)}-${fn.substring(2,4)}-${fn.substring(0,2)}`;
            const buffer = await file.arrayBuffer();
            const wb = XLSX.read(buffer, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const ins = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: Number(r.documentos_validados_fifo || 0), gradual_total: Number(r.documentos_validados_gradual_total || 0),
                gradual_parcial: Number(r.documentos_validados_gradual_parcial || 0), perfil_fc: Number(r.documentos_validados_perfil_fc || 0),
                quantidade: Number(r.documentos_validados || 0), data_referencia: dr, nome_arquivo: file.name
            })).filter(x => x.usuario_id);
            await _supabase.from('producao').insert(ins);
        }
        carregarDados();
    }

    function getWeek(d) {
        let date = new Date(d + 'T12:00:00');
        date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
        return Math.ceil((((date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
    }

    async function carregarDados() {
        const mesStr = document.getElementById('filtro-mes').value;
        const { data: pData } = await _supabase.from('producao').select('*, usuarios(*)').gte('data_referencia', `${mesStr}-01`).lte('data_referencia', `${mesStr}-31`).order('data_referencia', {ascending: false});
        const { data: mData } = await _supabase.from('metas').select('*');
        dadosGlobais = pData || []; metasGlobais = mData || [];
        
        if(dadosGlobais.length > 0) {
            renderizarKPIsMensais();
            alternarVisao();
        }
    }

    function renderizarKPIsMensais() {
        const as = dadosGlobais.filter(p => p.usuarios?.funcao === 'Assistente');
        const dias = new Set(as.map(p => p.data_referencia)).size || 1;
        const total = as.reduce((a,b) => a + b.quantidade, 0);
        const clt = as.filter(p => (p.usuarios.contrato || '').includes('CLT'));
        const pj = as.filter(p => !(p.usuarios.contrato || '').includes('CLT'));

        document.getElementById('kpi-total-mes').innerText = total.toLocaleString();
        document.getElementById('kpi-media-clt').innerText = clt.length > 0 ? (clt.reduce((a,b)=>a+b.quantidade,0) / dias).toFixed(0) : 0;
        document.getElementById('kpi-media-pj').innerText = pj.length > 0 ? (pj.reduce((a,b)=>a+b.quantidade,0) / dias).toFixed(0) : 0;
        
        let somaHead = 0;
        const dSet = new Set(as.map(p => p.data_referencia));
        dSet.forEach(d => somaHead += new Set(as.filter(x=>x.data_referencia===d).map(x=>x.usuarios.nome)).size);
        document.getElementById('kpi-media-as-dia').innerText = (somaHead / dias).toFixed(1);
    }

    function alternarVisao() {
        const visao = document.getElementById('view-selector').value;
        const areaDia = document.getElementById('area-dia');
        const corpo = document.getElementById('tabela-corpo');
        
        if(dadosGlobais.length === 0) return;

        if(visao === 'dia') {
            areaDia.classList.remove('hidden');
            const ultimaData = dadosGlobais[0].data_referencia;
            renderizarDestaqueDiario(ultimaData);
            renderizarTabela([ultimaData]);
        } else if(visao === 'semana') {
            areaDia.classList.add('hidden');
            const ultimaSemana = getWeek(dadosGlobais[0].data_referencia);
            const datasSemana = [...new Set(dadosGlobais.filter(p => getWeek(p.data_referencia) === ultimaSemana).map(p => p.data_referencia))];
            renderizarTabela(datasSemana);
        } else {
            areaDia.classList.add('hidden');
            const todasDatas = [...new Set(dadosGlobais.map(p => p.data_referencia))];
            renderizarTabela(todasDatas);
        }
    }

    function renderizarDestaqueDiario(dataFoco) {
        const dia = dadosGlobais.filter(p => p.data_referencia === dataFoco && p.usuarios?.funcao === 'Assistente');
        const total = dia.reduce((a, b) => a + b.quantidade, 0);
        const head = new Set(dia.map(x=>x.usuarios.nome)).size || 1;
        const clt = dia.filter(p => (p.usuarios.contrato || '').includes('CLT')).reduce((a,b)=>a+b.quantidade, 0);
        const pj = dia.filter(p => !(p.usuarios.contrato || '').includes('CLT')).reduce((a,b)=>a+b.quantidade, 0);

        document.getElementById('label-dia-foco').innerText = new Date(dataFoco + 'T12:00:00').toLocaleDateString('pt-BR');
        document.getElementById('label-headcount').innerText = `${head} Assistentes Ativos`;
        document.getElementById('d-total').innerText = total.toLocaleString();
        document.getElementById('d-media').innerText = (total/head).toFixed(0);
        document.getElementById('d-clt').innerText = clt.toLocaleString();
        document.getElementById('d-pj').innerText = pj.toLocaleString();
        document.getElementById('d-fifo').innerText = dia.reduce((a,b)=>a+b.fifo,0).toLocaleString();
        document.getElementById('d-gt').innerText = dia.reduce((a,b)=>a+b.gradual_total,0).toLocaleString();
    }

    function renderizarTabela(datas) {
        let stats = {};
        [...dadosGlobais].reverse().forEach(p => {
            const uid = p.usuario_id, wk = getWeek(p.data_referencia);
            if(!stats[uid]) stats[uid] = { m:0, d:0, s:{} };
            if(!stats[uid].s[wk]) stats[uid].s[wk] = { t:0, d:0 };
            stats[uid].m += p.quantidade; stats[uid].d++;
            stats[uid].s[wk].t += p.quantidade; stats[uid].s[wk].d++;
            p.tS = stats[uid].s[wk].t; p.mS = (p.tS / stats[uid].s[wk].d).toFixed(0);
            p.tM = stats[uid].mes = stats[uid].m; p.mM = (p.tM / stats[uid].d).toFixed(0);
        });

        let html = ''; let lastD = '';
        const filtrados = dadosGlobais.filter(p => datas.includes(p.data_referencia));

        filtrados.forEach(p => {
            const dt = new Date(p.data_referencia + 'T12:00:00').toLocaleDateString('pt-BR');
            if(dt !== lastD && datas.length > 1) { 
                html += `<tr class="divider-row"><td colspan="7">üìÖ Produ√ß√£o de ${dt}</td></tr>`; 
                lastD = dt; 
            }
            const meta = metasGlobais.filter(m => m.usuario_id == p.usuario_id && m.data_inicio <= p.data_referencia).sort((a,b)=>b.id-a.id)[0];
            const ating = meta ? ((p.quantidade / meta.valor_meta)*100).toFixed(0) : 0;
            html += `<tr>
                <td><strong>${p.usuarios?.nome}</strong></td>
                <td style="font-weight:800; color:var(--primary)">${p.quantidade}</td>
                <td>${p.tS}</td><td>${p.tM}</td><td>${p.mS}</td><td>${p.mM}</td>
                <td><span class="badge" style="background:${ating>=100?'#059669':'#dc2626'}">${ating}%</span></td>
            </tr>`;
        });
        document.getElementById('tabela-corpo').innerHTML = html;
    }

    carregarDados();
</script>
</body>
</html>

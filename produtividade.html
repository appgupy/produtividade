async function importarArquivos() {
    const files = document.getElementById('excel-files').files;
    let logs = { sucesso: 0, duplicados: 0, total_linhas: 0, ignorados_sem_id: 0 };
    
    for(let file of files) {
        const fn = file.name.replace('.xlsx', '');
        if(!/^\d{8}$/.test(fn)) continue; // Valida formato ddmmaaaa
        const dr = `${fn.substring(4,8)}-${fn.substring(2,4)}-${fn.substring(0,2)}`;
        
        const buffer = await file.arrayBuffer();
        const wb = XLSX.read(buffer, {type: 'array'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        for(let r of json) {
            logs.total_linhas++;
            
            // VALIDA√á√ÉO CR√çTICA: Se n√£o houver ID num√©rico, ignora a linha completamente
            if (!r.id_assistente || isNaN(r.id_assistente)) {
                logs.ignorados_sem_id++;
                continue; 
            }

            const { data: existe } = await _supabase.from('producao')
                .select('id')
                .eq('usuario_id', r.id_assistente)
                .eq('data_referencia', dr)
                .maybeSingle();
            
            if(existe) { 
                logs.duplicados++; 
                continue; 
            }

            const { error } = await _supabase.from('producao').insert({
                usuario_id: r.id_assistente,
                fifo: Number(r.documentos_validados_fifo || 0),
                gradual_total: Number(r.documentos_validados_gradual_total || 0),
                gradual_parcial: Number(r.documentos_validados_gradual_parcial || 0),
                perfil_fc: Number(r.documentos_validados_perfil_fc || 0),
                quantidade: Number(r.documentos_validados || 0),
                data_referencia: dr
            });
            
            if(!error) logs.sucesso++;
        }
    }
    
    // Relat√≥rio de Importa√ß√£o atualizado para mostrar quantos foram ignorados por falta de ID
    document.getElementById('log-content').innerHTML = `
        Linhas processadas: <b>${logs.total_linhas}</b><br>
        ‚úÖ Importados: <b style="color:green">${logs.sucesso}</b><br>
        ‚ö†Ô∏è Sem ID (Ignorados): <b style="color:red">${logs.ignorados_sem_id}</b><br>
        üîÅ Duplicados: <b>${logs.duplicados}</b>
    `;
    document.getElementById('import-log').style.display = 'block';
    carregarDados();
}

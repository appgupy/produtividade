<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat칩rio Detalhado - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e11d48; --success: #059669; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: var(--primary); color: white; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-item { background: white; padding: 15px; border-radius: 10px; border-bottom: 4px solid #cbd5e1; text-align: center; }
        .summary-item.total { border-bottom-color: var(--primary); }
        .summary-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .summary-value { font-size: 1.2rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .badge { padding: 3px 7px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="header">
    <h2>游늵 Produ칞칚o Detalhada</h2>
    <button class="btn" onclick="location.href='gestao.html'" style="background:#64748b;">Voltar  Gest칚o</button>
</div>

<div class="card">
    <h3 style="margin-top:0;">Importar Planilha Di치ria</h3>
    <input type="file" id="excel-file" accept=".xlsx">
    <button class="btn" onclick="processarExcel()">Carregar Dados</button>
</div>

<div class="card">
    <div style="margin-bottom: 20px;">
        <label>Ver Relat칩rio de:</label>
        <input type="date" id="filtro-data" onchange="carregarRelatorio()" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
    </div>

    <div class="summary-grid" id="resumo-detalhado">
        <div class="summary-item"><div class="summary-label">FIFO</div><div class="summary-value" id="tot-fifo">0</div></div>
        <div class="summary-item"><div class="summary-label">Grad. Total</div><div class="summary-value" id="tot-gt">0</div></div>
        <div class="summary-item"><div class="summary-label">Grad. Parcial</div><div class="summary-value" id="tot-gp">0</div></div>
        <div class="summary-item"><div class="summary-label">Perfil FC</div><div class="summary-value" id="tot-fc">0</div></div>
        <div class="summary-item total"><div class="summary-label">Soma Geral</div><div class="summary-value" id="tot-geral">0</div></div>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Assistente</th>
                    <th>FIFO</th>
                    <th>Grad. Total</th>
                    <th>Grad. Parcial</th>
                    <th>Perfil FC</th>
                    <th>Total</th>
                    <th>Meta</th>
                    <th>Ating.</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    document.getElementById('filtro-data').valueAsDate = new Date();

    async function processarExcel() {
        const file = document.getElementById('excel-file').files[0];
        if(!file) return alert("Selecione o arquivo!");
        
        const fileName = file.name.replace('.xlsx', '');
        const dataRef = `${fileName.substring(4,8)}-${fileName.substring(2,4)}-${fileName.substring(0,2)}`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            const inserts = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: r.documentos_validados_fifo || 0,
                gradual_total: r.documentos_validados_gradual_total || 0,
                gradual_parcial: r.documentos_validados_gradual_parcial || 0,
                perfil_fc: r.documentos_validados_perfil_fc || 0,
                quantidade: r.documentos_validados || 0,
                data_referencia: dataRef,
                nome_arquivo: file.name
            })).filter(x => x.usuario_id);

            const { error } = await _supabase.from('producao').insert(inserts);
            if(error) alert("Erro: Planilha j치 importada ou erro de IDs.");
            else { alert("Sucesso!"); carregarRelatorio(); }
        };
        reader.readAsArrayBuffer(file);
    }

    async function carregarRelatorio() {
        const dataBusca = document.getElementById('filtro-data').value;
        const { data: pData } = await _supabase.from('producao').select('*, usuarios(nome)').eq('data_referencia', dataBusca);
        const { data: mData } = await _supabase.from('metas').select('*');

        const tbody = document.getElementById('tabela-corpo');
        tbody.innerHTML = '';
        
        let totais = { fifo:0, gt:0, gp:0, fc:0, geral:0 };

        if(pData) {
            pData.forEach(p => {
                const metaUser = mData.filter(m => m.usuario_id == p.usuario_id).sort((a,b) => b.id - a.id)[0];
                const metaVal = metaUser ? metaUser.valor_meta : 0;
                const perc = metaVal > 0 ? ((p.quantidade / metaVal) * 100).toFixed(0) : 0;

                totais.fifo += p.fifo; totais.gt += p.gradual_total;
                totais.gp += p.gradual_parcial; totais.fc += p.perfil_fc;
                totais.geral += p.quantidade;

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${p.usuarios?.nome || 'ID:'+p.usuario_id}</strong></td>
                        <td>${p.fifo}</td>
                        <td>${p.gradual_total}</td>
                        <td>${p.gradual_parcial}</td>
                        <td>${p.perfil_fc}</td>
                        <td><strong>${p.quantidade}</strong></td>
                        <td>${metaVal}</td>
                        <td><span class="badge ${perc >= 100 ? 'bg-green' : 'bg-red'}">${perc}%</span></td>
                    </tr>
                `;
            });
        }

        document.getElementById('tot-fifo').innerText = totais.fifo;
        document.getElementById('tot-gt').innerText = totais.gt;
        document.getElementById('tot-gp').innerText = totais.gp;
        document.getElementById('tot-fc').innerText = totais.fc;
        document.getElementById('tot-geral').innerText = totais.geral;
    }

    carregarRelatorio();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produtividade</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --clt: #0284c7; --pj: #7c3aed; --bg: #f8fafc; --nav: #1e293b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 85px; color: #1e293b; }

        /* NAVBAR SaaS */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--nav); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .nav-left { display: flex; align-items: center; gap: 30px; }
        .brand { line-height: 1; cursor: pointer; }
        .brand .small { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; display: block; margin-bottom: 2px; }
        .brand .big { font-size: 1.2rem; font-weight: 800; letter-spacing: -1px; color: white; }
        .brand .big span { color: var(--primary); }

        .nav-tools { display: flex; align-items: center; gap: 12px; background: #334155; padding: 6px 15px; border-radius: 10px; border: 1px solid #475569; }
        .nav-tools select, .nav-tools input { background: transparent; border: none; color: white; font-size: 0.8rem; font-weight: 600; outline: none; }
        .nav-tools option { background: var(--nav); color: white; }

        .btn-import { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; cursor: pointer; }
        .user-section { display: flex; align-items: center; gap: 15px; border-left: 1px solid #334155; padding-left: 20px; text-align: right; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* PAINEL DE ANALISE DETALHADA */
        .daily-focus { background: #1e293b; color: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .daily-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; }
        .daily-stat .label { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
        .daily-stat .value { font-size: 1.1rem; font-weight: 800; display: block; margin-top: 4px; }

        /* TABELA COM CATEGORIAS */
        .table-wrap { background: white; border-radius: 15px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1100px; }
        th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        
        .divider-row { background: #f1f5f9 !important; color: #1e293b; font-weight: 800; font-size: 0.75rem; }
        .badge { padding: 3px 8px; border-radius: 12px; font-weight: 800; font-size: 0.65rem; color: white; }
        .col-cat { background: #fcfcfc; font-weight: 600; color: #64748b; text-align: center; border-left: 1px solid #eee; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <div class="brand" onclick="location.reload()">
            <span class="small">controle de</span>
            <div class="big">PRODUTIVIDADE<span>.</span></div>
        </div>

        <div class="nav-tools">
            <select id="view-selector" onchange="alternarVisao()">
                <option value="dia">üîç An√°lise Detalhada (Dia)</option>
                <option value="semana">üìÖ Resumo da Semana</option>
                <option value="mes">üìä Relat√≥rio Mensal</option>
            </select>
            <div style="width:1px; height:20px; background:#475569;"></div>
            <input type="date" id="input-data-especifica" onchange="alternarVisao()" title="Escolha o dia para analisar">
            <input type="month" id="filtro-mes" onchange="carregarDados()" title="M√™s de refer√™ncia">
        </div>
    </div>

    <div class="nav-right">
        <button class="btn-import" onclick="document.getElementById('excel-files').click()">üì• Importar</button>
        <input type="file" id="excel-files" accept=".xlsx" multiple class="hidden" onchange="importarArquivos()">
        
        <div class="user-section">
            <div>
                <span style="font-size: 0.85rem; font-weight: 700; display: block;" id="user-name">Patr√≠cia</span>
                <span style="color: #f87171; font-size: 0.7rem; cursor: pointer; font-weight: 700;" onclick="logout()">Sair</span>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    
    <div id="area-dia" class="daily-focus">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.1rem;">üìå Detalhamento do Time: <span id="label-dia-foco" style="color:var(--primary)">-</span></h2>
            <span id="label-headcount" style="font-size:0.75rem; font-weight:600; background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:20px;">0 Assistentes</span>
        </div>
        <div class="daily-grid">
            <div class="daily-stat"><span class="label">Total Geral</span><span class="value" id="d-total">0</span></div>
            <div class="daily-stat"><span class="label">M√©dia Time</span><span class="value" id="d-media">0</span></div>
            <div class="daily-stat"><span class="label">CLT Prod.</span><span class="value" style="color:var(--clt)" id="d-clt">0</span></div>
            <div class="daily-stat"><span class="label">PJ Prod.</span><span class="value" style="color:var(--pj)" id="d-pj">0</span></div>
            <div class="daily-stat"><span class="label">FIFO</span><span class="value" id="d-fifo">0</span></div>
            <div class="daily-stat"><span class="label">Gradual T.</span><span class="value" id="d-gt">0</span></div>
            <div class="daily-stat"><span class="label">Gradual P.</span><span class="value" id="d-gp">0</span></div>
            <div class="daily-stat"><span class="label">Perfil FC</span><span class="value" id="d-fc">0</span></div>
        </div>
    </div>

    <div class="table-wrap">
        <table id="main-table">
            <thead>
                <tr>
                    <th>Assistente</th>
                    <th style="color:var(--primary); text-align:center;">Produ√ß√£o</th>
                    <th class="col-cat">FIFO</th>
                    <th class="col-cat">G. Total</th>
                    <th class="col-cat">G. Parcial</th>
                    <th class="col-cat">P. FC</th>
                    <th>Semana</th>
                    <th>M√™s</th>
                    <th>M√©d. Sem</th>
                    <th>M√©d. M√™s</th>
                    <th>Meta</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    let dadosGlobais = [], metasGlobais = [];

    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if(!sessao) window.location.href = 'index.html';
    document.getElementById('user-name').innerText = sessao.nome;
    
    // Inicia com o m√™s atual e a data de hoje para o seletor de dia
    document.getElementById('filtro-mes').value = new Date().toISOString().substring(0,7);
    document.getElementById('input-data-especifica').value = new Date().toISOString().substring(0,10);

    function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }

    async function importarArquivos() {
        const files = document.getElementById('excel-files').files;
        for(let file of files) {
            const fn = file.name.replace('.xlsx', '');
            if(!/^\d{8}$/.test(fn)) continue;
            const dr = `${fn.substring(4,8)}-${fn.substring(2,4)}-${fn.substring(0,2)}`;
            const buffer = await file.arrayBuffer();
            const wb = XLSX.read(buffer, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const ins = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: Number(r.documentos_validados_fifo || 0), gradual_total: Number(r.documentos_validados_gradual_total || 0),
                gradual_parcial: Number(r.documentos_validados_gradual_parcial || 0), perfil_fc: Number(r.documentos_validados_perfil_fc || 0),
                quantidade: Number(r.documentos_validados || 0), data_referencia: dr, nome_arquivo: file.name
            })).filter(x => x.usuario_id);
            await _supabase.from('producao').insert(ins);
        }
        carregarDados();
    }

    function getWeek(d) {
        let date = new Date(d + 'T12:00:00');
        date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
        return Math.ceil((((date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
    }

    async function carregarDados() {
        const mesStr = document.getElementById('filtro-mes').value;
        const { data: pData } = await _supabase.from('producao').select('*, usuarios(*)').gte('data_referencia', `${mesStr}-01`).lte('data_referencia', `${mesStr}-31`).order('data_referencia', {ascending: false});
        const { data: mData } = await _supabase.from('metas').select('*');
        dadosGlobais = pData || []; metasGlobais = mData || [];
        alternarVisao();
    }

    function alternarVisao() {
        const visao = document.getElementById('view-selector').value;
        const inputData = document.getElementById('input-data-especifica');
        const areaDia = document.getElementById('area-dia');
        
        // Mostrar/Esconder o seletor de data conforme a vis√£o
        inputData.classList.toggle('hidden', visao !== 'dia');

        if(dadosGlobais.length === 0) {
            document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="11" style="text-align:center">Nenhum dado encontrado para este per√≠odo.</td></tr>';
            return;
        }

        if(visao === 'dia') {
            areaDia.classList.remove('hidden');
            const dataFoco = inputData.value;
            renderizarDestaqueDiario(dataFoco);
            renderizarTabela([dataFoco]);
        } else if(visao === 'semana') {
            areaDia.classList.add('hidden');
            const ultimaSemana = getWeek(dadosGlobais[0].data_referencia);
            const datasSemana = [...new Set(dadosGlobais.filter(p => getWeek(p.data_referencia) === ultimaSemana).map(p => p.data_referencia))];
            renderizarTabela(datasSemana);
        } else {
            areaDia.classList.add('hidden');
            const todasDatas = [...new Set(dadosGlobais.map(p => p.data_referencia))];
            renderizarTabela(todasDatas);
        }
    }

    function renderizarDestaqueDiario(dataFoco) {
        const dia = dadosGlobais.filter(p => p.data_referencia === dataFoco && p.usuarios?.funcao === 'Assistente');
        const total = dia.reduce((a, b) => a + b.quantidade, 0);
        const head = new Set(dia.map(x=>x.usuarios.nome)).size || 1;
        
        document.getElementById('label-dia-foco').innerText = new Date(dataFoco + 'T12:00:00').toLocaleDateString('pt-BR');
        document.getElementById('label-headcount').innerText = `${head} Assistentes`;
        document.getElementById('d-total').innerText = total.toLocaleString();
        document.getElementById('d-media').innerText = (total/head).toFixed(0);
        document.getElementById('d-clt').innerText = dia.filter(p => (p.usuarios.contrato || '').includes('CLT')).reduce((a,b)=>a+b.quantidade,0).toLocaleString();
        document.getElementById('d-pj').innerText = dia.filter(p => !(p.usuarios.contrato || '').includes('CLT')).reduce((a,b)=>a+b.quantidade,0).toLocaleString();
        document.getElementById('d-fifo').innerText = dia.reduce((a,b)=>a+b.fifo,0).toLocaleString();
        document.getElementById('d-gt').innerText = dia.reduce((a,b)=>a+b.gradual_total,0).toLocaleString();
        document.getElementById('d-gp').innerText = dia.reduce((a,b)=>a+b.gradual_parcial,0).toLocaleString();
        document.getElementById('d-fc').innerText = dia.reduce((a,b)=>a+b.perfil_fc,0).toLocaleString();
    }

    function renderizarTabela(datas) {
        let stats = {};
        [...dadosGlobais].reverse().forEach(p => {
            const uid = p.usuario_id, wk = getWeek(p.data_referencia);
            if(!stats[uid]) stats[uid] = { m:0, d:0, s:{} };
            if(!stats[uid].s[wk]) stats[uid].s[wk] = { t:0, d:0 };
            stats[uid].m += p.quantidade; stats[uid].d++;
            stats[uid].s[wk].t += p.quantidade; stats[uid].s[wk].d++;
            p.tS = stats[uid].s[wk].t; p.mS = (p.tS / stats[uid].s[wk].d).toFixed(0);
            p.tM = stats[uid].m; p.mM = (p.tM / stats[uid].d).toFixed(0);
        });

        let html = ''; let lastD = '';
        const filtrados = dadosGlobais.filter(p => datas.includes(p.data_referencia));

        if(filtrados.length === 0) {
            html = '<tr><td colspan="11" style="text-align:center">Nenhum dado para a data selecionada.</td></tr>';
        }

        filtrados.forEach(p => {
            const dt = new Date(p.data_referencia + 'T12:00:00').toLocaleDateString('pt-BR');
            if(dt !== lastD && datas.length > 1) { 
                html += `<tr class="divider-row"><td colspan="11">üìÖ PRODU√á√ÉO DE ${dt}</td></tr>`; 
                lastD = dt; 
            }
            const meta = metasGlobais.filter(m => m.usuario_id == p.usuario_id && m.data_inicio <= p.data_referencia).sort((a,b)=>b.id-a.id)[0];
            const ating = meta ? ((p.quantidade / meta.valor_meta)*100).toFixed(0) : 0;
            
            html += `<tr>
                <td><strong>${p.usuarios?.nome}</strong></td>
                <td style="font-weight:800; color:var(--primary); text-align:center;">${p.quantidade}</td>
                <td class="col-cat">${p.fifo}</td>
                <td class="col-cat">${p.gradual_total}</td>
                <td class="col-cat">${p.gradual_parcial}</td>
                <td class="col-cat">${p.perfil_fc}</td>
                <td>${p.tS}</td><td>${p.tM}</td><td>${p.mS}</td><td>${p.mM}</td>
                <td><span class="badge" style="background:${ating>=100?'#059669':'#dc2626'}">${ating}%</span></td>
            </tr>`;
        });
        document.getElementById('tabela-corpo').innerHTML = html;
    }

    carregarDados();
</script>
</body>
</html>

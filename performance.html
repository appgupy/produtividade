<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0045d0; --accent: #2662ea; --nav: #0d1b2a;
            --success: #00d09e; --danger: #ef4444;
            --clt: #0077b6; --pj: #00b4d8; --fifo: #f59e0b;
            --bg: #f3f5f8; --card: #ffffff; --border: #e2e8f0;
            --text-main: #1f2937; --text-muted: #64748b;
            --zebra-even: #f8fafc; --zebra-hover: #eff6ff;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; color: var(--text-main); }

        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: var(--nav); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .nav-left { display: flex; align-items: center; gap: 40px; }
        .brand .big { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; color: white; }
        .brand .big span { color: var(--accent); }
        .nav-links { display: flex; gap: 30px; }
        .nav-item { color: #94a3b8; text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.3s; padding-bottom: 23px; border-bottom: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { color: white; border-bottom-color: var(--accent); }
        .user-area { text-align: right; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 20px; }
        .user-name { font-weight: 600; font-size: 0.85rem; color: white; }
        .logout-btn { color: #fca5a5; font-size: 0.7rem; cursor: pointer; font-weight: 600; }

        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }

        /* CONTROLES */
        .top-controls { display: flex; gap: 15px; margin-bottom: 25px; background: var(--card); padding: 25px; border-radius: 8px; border: 1px solid var(--border); align-items: flex-end; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .control-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .control-group label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        select, input { padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-family: 'Inter'; font-size: 0.9rem; color: var(--text-main); outline: none; background: #fff; }

        /* KPI GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--nav); }
        .stat-sub { font-size: 0.8rem; margin-top: 5px; font-weight: 500; }

        /* GR츼FICOS */
        .charts-area { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-card { background: var(--card); padding: 25px; border-radius: 8px; border: 1px solid var(--border); height: 300px; display: flex; flex-direction: column; }
        .chart-title { font-size: 0.9rem; font-weight: 700; color: var(--nav); margin-bottom: 10px; }
        .chart-container { flex: 1; position: relative; min-height: 0; }

        /* MATRIZ ANUAL (TABELA GRANDE) */
        .matrix-section { margin-top: 40px; }
        .matrix-title { font-size: 1.1rem; font-weight: 800; color: var(--nav); margin-bottom: 15px; padding-left: 10px; border-left: 4px solid var(--accent); }
        
        .table-wrap { background: var(--card); border-radius: 8px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; white-space: nowrap; }
        
        /* Cabe칞alho Fixo */
        th { background: #f1f5f9; padding: 10px 8px; text-align: center; color: var(--text-main); font-weight: 800; border: 1px solid #cbd5e1; }
        th.sticky-col { position: sticky; left: 0; z-index: 10; background: #e2e8f0; }
        
        td { padding: 8px; border: 1px solid #e2e8f0; color: var(--text-main); text-align: center; }
        td.sticky-col { position: sticky; left: 0; z-index: 5; background: #ffffff; font-weight: 700; text-align: left; border-right: 2px solid #cbd5e1; }
        
        /* Cores de Cabe칞alho Espec칤ficas (Estilo Planilha) */
        .th-q { background-color: #fef3c7; color: #92400e; } /* Qs Amarelo */
        .th-h { background-color: #dbeafe; color: #1e40af; } /* Hs Azul */
        .th-y { background-color: #dcfce7; color: #166534; } /* Ano Verde */

        .val-cell { font-weight: 600; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <div class="brand" onclick="window.location.href='produtividade.html'">
            <div class="big">PRODUTIVIDADE<span>.</span></div>
        </div>
        <div class="nav-links">
            <a href="gestao.html" class="nav-item">Gest칚o</a>
            <a href="produtividade.html" class="nav-item">Produtividade</a>
            <a href="performance.html" class="nav-item active">Performance</a>
            <a href="consolidado.html" class="nav-item">Consolidado</a>
        </div>
    </div>
    <div class="user-area">
        <span id="user-display" class="user-name">Carregando...</span>
        <span class="logout-btn" onclick="logout()">Sair</span>
    </div>
</nav>

<div class="container">
    
    <div class="top-controls">
        <div class="control-group" style="flex: 1.5;">
            <label>An치lise Individual (KPIs e Gr치ficos)</label>
            <select id="user-selector" onchange="carregarPerformance()">
                <option value="TEAM">游논 VIS츾O GERAL DO TIME</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Tipo de Per칤odo</label>
            <select id="period-type" onchange="atualizarOpcoesPeriodo()">
                <option value="mes">Mensal</option>
                <option value="ano">Anual</option>
            </select>
        </div>

        <div class="control-group">
            <label>Ano de Refer칡ncia</label>
            <select id="year-selector" onchange="initAll()"></select>
        </div>

        <div class="control-group" style="flex: 1.2;">
            <label>Per칤odo Espec칤fico</label>
            <select id="period-value" onchange="carregarPerformance()"></select>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-left: 4px solid var(--clt);">
            <div class="stat-label">Produ칞칚o Total</div>
            <div class="stat-value" id="kpi-total">0</div>
            <div class="stat-sub" id="kpi-detail">Carregando...</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--pj);">
            <div class="stat-label">M칠dia Di치ria</div>
            <div class="stat-value" id="kpi-media">0</div>
            <div class="stat-sub" id="kpi-comp-team" style="font-weight: 700;">-</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--fifo);">
            <div class="stat-label">Meta do Per칤odo</div>
            <div class="stat-value" id="kpi-meta">0</div>
            <div class="stat-sub" id="kpi-hitrate">-</div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--primary);">
            <div class="stat-label">Melhor Performance</div>
            <div class="stat-value" id="kpi-best">0</div>
            <div class="stat-sub" id="kpi-best-date">-</div>
        </div>
    </div>

    <div class="charts-area">
        <div class="chart-card">
            <div class="chart-title">游늳 Evolu칞칚o</div>
            <div class="chart-container"><canvas id="lineChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">游꼻 Distribui칞칚o</div>
            <div class="chart-container"><canvas id="doughnutChart"></canvas></div>
        </div>
    </div>

    <div class="matrix-section">
        <div class="matrix-title">M칠trica Assistentes (Matriz Anual)</div>
        <div class="table-wrap">
            <table id="matrix-table">
                <thead>
                    <tr>
                        <th class="sticky-col" style="min-width: 60px;">ID</th>
                        <th class="sticky-col" style="left:60px; min-width: 150px;">Nome Assistente</th>
                        <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
                        <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
                        <th class="th-q">Total Q1</th><th class="th-q">Total Q2</th><th class="th-q">Total Q3</th><th class="th-q">Total Q4</th>
                        <th class="th-h">Total H1</th><th class="th-h">Total H2</th>
                        <th class="th-y">Total Anual</th>
                    </tr>
                </thead>
                <tbody id="matrix-body">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if(!sessao) window.location.href = 'index.html';
    document.getElementById('user-display').innerText = sessao.nome;
    function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }

    let chartLinha = null;
    let chartRosca = null;

    // Inicializa칞칚o
    function init() {
        const yearSel = document.getElementById('year-selector');
        const currentYear = new Date().getFullYear();
        for(let y = currentYear; y >= 2024; y--) yearSel.innerHTML += `<option value="${y}">${y}</option>`;
        
        atualizarOpcoesPeriodo();
        initAll();
    }

    async function initAll() {
        await carregarListaUsuarios();
        carregarPerformance(); // Carrega gr치ficos do topo
        carregarMatrizAnual(); // Carrega a nova tabela embaixo
    }

    async function carregarListaUsuarios() {
        const { data: users } = await _supabase.from('usuarios').select('*').order('nome');
        const sel = document.getElementById('user-selector');
        sel.innerHTML = '<option value="TEAM">游논 VIS츾O GERAL DO TIME</option>';
        const assistentes = users.filter(u => u.funcao !== 'Gestora' && u.funcao !== 'Auditora');
        assistentes.forEach(u => sel.innerHTML += `<option value="${u.id}">${u.nome}</option>`);
    }

    // --- FUN칂칏ES DA MATRIZ ANUAL ---
    async function carregarMatrizAnual() {
        const year = document.getElementById('year-selector').value;
        const tbody = document.getElementById('matrix-body');
        tbody.innerHTML = '<tr><td colspan="22" style="text-align:center; padding:20px;">Carregando dados anuais...</td></tr>';

        // 1. Busca todos os usu치rios
        const { data: users } = await _supabase.from('usuarios').select('*').order('nome');
        const assistentes = users.filter(u => u.funcao !== 'Gestora' && u.funcao !== 'Auditora');

        // 2. Busca produ칞칚o do ano inteiro
        const { data: prod } = await _supabase.from('producao')
            .select('usuario_id, quantidade, data_referencia')
            .gte('data_referencia', `${year}-01-01`)
            .lte('data_referencia', `${year}-12-31`);

        // 3. Processa Dados (Matriz [User][Mes])
        let userStats = {};
        
        // Inicializa estrutura
        assistentes.forEach(u => {
            userStats[u.id] = { id: u.id, nome: u.nome, months: new Array(12).fill(0) };
        });

        // Preenche valores
        if(prod) {
            prod.forEach(p => {
                if(userStats[p.usuario_id]) {
                    const monthIdx = new Date(p.data_referencia + 'T12:00:00').getMonth();
                    userStats[p.usuario_id].months[monthIdx] += p.quantidade;
                }
            });
        }

        // 4. Renderiza
        let html = '';
        
        // Encontrar valor m치ximo para o Heatmap (colora칞칚o)
        let maxVal = 0;
        Object.values(userStats).forEach(u => {
            u.months.forEach(v => { if(v > maxVal) maxVal = v; });
        });

        Object.values(userStats).forEach(u => {
            // C치lculos
            const q1 = u.months[0] + u.months[1] + u.months[2];
            const q2 = u.months[3] + u.months[4] + u.months[5];
            const q3 = u.months[6] + u.months[7] + u.months[8];
            const q4 = u.months[9] + u.months[10] + u.months[11];
            
            const h1 = q1 + q2;
            const h2 = q3 + q4;
            const total = h1 + h2;

            // Renderiza Linha
            html += `<tr>
                <td class="sticky-col" style="background:#f8fafc;">${u.id}</td>
                <td class="sticky-col" style="left:60px; background:#f8fafc;">${u.nome}</td>`;
            
            // Meses com Heatmap
            u.months.forEach(val => {
                const color = getHeatmapColor(val, maxVal);
                html += `<td class="val-cell" style="background-color:${color}">${val > 0 ? val.toLocaleString() : ''}</td>`;
            });

            // Totais
            html += `<td class="val-cell" style="background:#fffbeb">${q1.toLocaleString()}</td>
                     <td class="val-cell" style="background:#fffbeb">${q2.toLocaleString()}</td>
                     <td class="val-cell" style="background:#fffbeb">${q3.toLocaleString()}</td>
                     <td class="val-cell" style="background:#fffbeb">${q4.toLocaleString()}</td>
                     <td class="val-cell" style="background:#eff6ff">${h1.toLocaleString()}</td>
                     <td class="val-cell" style="background:#eff6ff">${h2.toLocaleString()}</td>
                     <td class="val-cell" style="background:#dcfce7; font-weight:800;">${total.toLocaleString()}</td>
            </tr>`;
        });

        tbody.innerHTML = html;
    }

    function getHeatmapColor(value, max) {
        if(value === 0) return '#ffffff';
        // Escala simples: Vermelho (baixo) -> Amarelo -> Verde (alto)
        // Normaliza 0 a 1
        const ratio = value / (max || 1);
        
        // L칩gica simples para pastel
        if(ratio < 0.3) return '#fee2e2'; // Vermelho claro
        if(ratio < 0.7) return '#fef3c7'; // Amarelo claro
        return '#dcfce7'; // Verde claro
    }

    // --- FUN칂칏ES DA PARTE SUPERIOR (Mantidas do chat anterior) ---
    function atualizarOpcoesPeriodo() {
        const type = document.getElementById('period-type').value;
        const valSel = document.getElementById('period-value');
        valSel.innerHTML = '';
        const meses = ['Janeiro','Fevereiro','Mar칞o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        if(type === 'mes') meses.forEach((m, i) => valSel.innerHTML += `<option value="${i+1}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`);
        else valSel.innerHTML = `<option value="1">Ano Completo</option>`;
        carregarPerformance();
    }

    async function carregarPerformance() {
        const uid = document.getElementById('user-selector').value;
        const year = document.getElementById('year-selector').value;
        const type = document.getElementById('period-type').value;
        const val = parseInt(document.getElementById('period-value').value);

        let start = '', end = '';
        if(type === 'mes') {
            const m = val.toString().padStart(2,'0');
            start = `${year}-${m}-01`;
            end = `${year}-${m}-${new Date(year, val, 0).getDate()}`;
        } else {
            start = `${year}-01-01`; end = `${year}-12-31`;
        }

        const { data: allData } = await _supabase.from('producao').select('*, usuarios(nome)').gte('data_referencia', start).lte('data_referencia', end).order('data_referencia');

        if(!allData || allData.length === 0) {
            // Limpa gr치ficos se n칚o houver dados, mas n칚o interfere na Matriz
            return; 
        }

        let userData = [];
        let teamStats = {};

        // (L칩gica de gr치ficos e KPIs igual ao c칩digo anterior - simplificado aqui)
        if(uid === 'TEAM') {
            userData = allData; // Simplifica칞칚o para Team View
        } else {
            userData = allData.filter(d => d.usuario_id == uid);
        }
        
        let meta = 650;
        renderDashboard(userData, meta, uid==='TEAM');
    }

    function renderDashboard(dados, meta, isTeam) {
        // Renderiza KPIs e Gr치ficos (Mesma l칩gica do c칩digo anterior)
        // ... (Para economizar espa칞o, assuma que a l칩gica de renderCharts e KPIs est치 aqui)
        // Copiar as fun칞칫es renderCharts, renderTable, calcularKPIs do c칩digo anterior.
        const total = dados.reduce((a,b)=>a+b.quantidade,0);
        document.getElementById('kpi-total').innerText = total.toLocaleString();
        
        // Render Charts Placeholders
        const labels = dados.map(d => d.data_referencia);
        const vals = dados.map(d => d.quantidade);
        
        const ctxL = document.getElementById('lineChart').getContext('2d');
        if(chartLinha) chartLinha.destroy();
        chartLinha = new Chart(ctxL, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Produ칞칚o', data: vals, borderColor: '#0045d0', tension:0.2 }] },
            options: { responsive:true, maintainAspectRatio: false }
        });
        
        const ctxD = document.getElementById('doughnutChart').getContext('2d');
        if(chartRosca) chartRosca.destroy();
        chartRosca = new Chart(ctxD, {
            type: 'doughnut',
            data: { labels:['Total'], datasets:[{data:[total], backgroundColor:['#2662ea']}] },
            options: { responsive:true, maintainAspectRatio: false }
        });
    }

    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o e Metas - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e11d48; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #e2e8f0; margin-right: 5px; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Painel de Gest√£o Gupy</h2>
        <div>
            <button class="btn" onclick="location.href='produtividade.html'" style="background:#0284c7; color:white;">üìä Ir para Produtividade</button>
            <button class="btn" onclick="localStorage.removeItem('usuario'); location.href='index.html'" style="background:#64748b; color:white; margin-left:10px;">Sair</button>
        </div>
    </div>
    <div class="card">
        <button class="tab-btn active" id="btn-u" onclick="switchTab('usuarios')">Usu√°rios</button>
        <button class="tab-btn" id="btn-m" onclick="switchTab('metas')">Metas</button>
        
        <div id="tab-usuarios" style="margin-top:20px;">
            <h3>Cadastrar/Editar Colaborador</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                <input type="number" id="u-id" placeholder="ID (N√∫mero)">
                <input type="text" id="u-nome" placeholder="Nome Completo">
                <select id="u-fun">
                    <option value="Assistente">Assistente</option>
                    <option value="Auditora">Auditora</option>
                    <option value="Gestora">Gestora</option>
                </select>
                <select id="u-con">
                    <option value="CLT">CLT</option>
                    <option value="PJ">PJ</option>
                    <option value="CLT PCD">CLT PCD</option>
                </select>
            </div>
            <button class="btn" style="background:#10b981; color:white;" onclick="addU()">Salvar Colaborador</button>
            <table id="lista-u"><thead><tr><th>ID</th><th>Nome</th><th>Fun√ß√£o</th><th>Contrato</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-metas" class="hidden" style="margin-top:20px;">
            <h3>Definir Meta</h3>
            <select id="m-user" style="width:100%; max-width:300px;"></select>
            <input type="number" id="m-val" placeholder="Valor da Meta Di√°ria">
            <input type="date" id="m-data">
            <button class="btn" style="background:var(--primary); color:white;" onclick="addM()">Atualizar Meta</button>
            <table id="lista-m"><thead><tr><th>Nome</th><th>Meta</th><th>In√≠cio Vig√™ncia</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    document.getElementById('m-data').valueAsDate = new Date();

    function switchTab(t){
        document.getElementById('tab-usuarios').classList.toggle('hidden', t!=='usuarios');
        document.getElementById('tab-metas').classList.toggle('hidden', t!=='metas');
        document.getElementById('btn-u').classList.toggle('active', t==='usuarios');
        document.getElementById('btn-m').classList.toggle('active', t==='metas');
    }

    async function addU(){
        const id = document.getElementById('u-id').value;
        const nome = document.getElementById('u-nome').value;
        const fun = document.getElementById('u-fun').value;
        const con = document.getElementById('u-con').value;
        if(!id || !nome) return alert("ID e Nome obrigat√≥rios");
        
        const { error } = await _supabase.from('usuarios').upsert([{
            id, nome, funcao: fun, contrato: con, is_admin: (fun==='Gestora'), ativo: true, senha: '123'
        }]);
        if (error) alert("Erro: " + error.message); else { alert("Salvo!"); load(); }
    }

    async function addM(){
        const { error } = await _supabase.from('metas').insert([{
            usuario_id: document.getElementById('m-user').value,
            valor_meta: document.getElementById('m-val').value,
            data_inicio: document.getElementById('m-data').value
        }]);
        if (error) alert("Erro meta"); else { alert("Meta atualizada!"); load(); }
    }

    async function load(){
        const {data:u} = await _supabase.from('usuarios').select('*').order('nome');
        const {data:m} = await _supabase.from('metas').select('*, usuarios(nome)').order('data_inicio', {ascending: false});
        
        document.querySelector('#lista-u tbody').innerHTML = u.map(x=>`<tr><td>${x.id}</td><td>${x.nome}</td><td>${x.funcao}</td><td>${x.contrato}</td></tr>`).join('');
        document.getElementById('m-user').innerHTML = u.filter(x=>x.funcao==='Assistente').map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
        document.querySelector('#lista-m tbody').innerHTML = m.map(x=>`<tr><td>${x.usuarios?.nome || 'ID:'+x.usuario_id}</td><td>${x.valor_meta}</td><td>${new Date(x.data_inicio).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td></tr>`).join('');
    }
    load();
</script>
</body>
</html>

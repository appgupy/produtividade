<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Usu√°rios - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e11d48; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; color: #64748b; font-size: 0.85rem; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .btn-edit { background: #3b82f6; color: white; margin-right: 5px; }
        .btn-status { background: #ef4444; color: white; }
        .btn-active { background: #10b981; color: white; }
        .modal { background: white; padding: 20px; border-radius: 10px; border: 1px solid #ccc; margin-top: 20px; }
        .hidden { display: none; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin-right: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h2>Painel de Gest√£o</h2>
    <div>
        <span id="admin-nome">...</span>
        <button class="btn" onclick="logout()" style="background:#64748b; color:white; margin-left:15px;">Sair</button>
    </div>
</div>

<div class="card">
    <h3>Novo / Editar Usu√°rio</h3>
    <div id="form-usuario">
        <input type="number" id="user-id" placeholder="ID (N√∫mero)">
        <input type="text" id="user-nome" placeholder="Nome Completo">
        <select id="user-funcao">
            <option value="Assistente">Assistente</option>
            <option value="Auditora">Auditora</option>
            <option value="Gestora">Gestora</option>
        </select>
        <select id="user-contrato">
            <option value="CLT">CLT</option>
            <option value="PJ">PJ</option>
            <option value="CLT PCD">CLT PCD</option>
        </select>
        <button class="btn btn-active" onclick="salvarUsuario()">Salvar Usu√°rio</button>
        <button id="btn-cancelar" class="btn hidden" onclick="limparFormulario()" style="background:#64748b; color:white;">Cancelar</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>NOME</th>
                <th>FUN√á√ÉO</th>
                <th>CONTRATO</th>
                <th>STATUS</th>
                <th>A√á√ïES</th>
            </tr>
        </thead>
        <tbody id="tabela-usuarios">
            </tbody>
    </table>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let editandoId = null;

    // Verificar se o usu√°rio est√° logado e √© Gestora/Auditora
    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if (!sessao || (sessao.funcao !== 'Gestora' && sessao.funcao !== 'Auditora')) {
        window.location.href = 'index.html';
    } else {
        document.getElementById('admin-nome').innerText = sessao.nome;
        carregarUsuarios();
    }

    async function carregarUsuarios() {
        const { data, error } = await _supabase.from('usuarios').select('*').order('nome', { ascending: true });
        if (error) return alert("Erro ao carregar");

        const lista = document.getElementById('tabela-usuarios');
        lista.innerHTML = '';
        data.forEach(u => {
            lista.innerHTML += `
                <tr style="opacity: ${u.ativo ? '1' : '0.5'}">
                    <td>${u.id}</td>
                    <td>${u.nome}</td>
                    <td>${u.funcao}</td>
                    <td>${u.contrato}</td>
                    <td>${u.ativo ? '‚úÖ Ativo' : 'üö´ Inativo'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="prepararEdicao(${u.id}, '${u.nome}', '${u.funcao}', '${u.contrato}')">Editar</button>
                        <button class="btn ${u.ativo ? 'btn-status' : 'btn-active'}" onclick="alternarStatus(${u.id}, ${u.ativo})">
                            ${u.ativo ? 'Inativar' : 'Ativar'}
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    async function salvarUsuario() {
        const id = document.getElementById('user-id').value;
        const nome = document.getElementById('user-nome').value;
        const funcao = document.getElementById('user-funcao').value;
        const contrato = document.getElementById('user-contrato').value;

        if (!id || !nome) return alert("Preencha ID e Nome");

        if (editandoId) {
            // EDITAR
            const { error } = await _supabase.from('usuarios').update({ nome, funcao, contrato }).eq('id', id);
            if (error) alert("Erro ao atualizar");
        } else {
            // CRIAR NOVO
            const { error } = await _supabase.from('usuarios').insert([{ id, nome, funcao, contrato, senha: '123', primeiro_acesso: true, is_admin: (funcao === 'Gestora') }]);
            if (error) alert("Erro ao criar (ID j√° existe?)");
        }
        
        limparFormulario();
        carregarUsuarios();
    }

    async function alternarStatus(id, statusAtual) {
        if (id === 432243) return alert("A gestora principal n√£o pode ser inativada.");
        
        const confirmacao = confirm(`Deseja realmente ${statusAtual ? 'Inativar' : 'Ativar'} este usu√°rio?`);
        if (!confirmacao) return;

        const { error } = await _supabase.from('usuarios').update({ ativo: !statusAtual }).eq('id', id);
        if (error) alert("Erro ao alterar status");
        carregarUsuarios();
    }

    function prepararEdicao(id, nome, funcao, contrato) {
        editandoId = id;
        document.getElementById('user-id').value = id;
        document.getElementById('user-id').disabled = true; // N√£o muda o ID
        document.getElementById('user-nome').value = nome;
        document.getElementById('user-funcao').value = funcao;
        document.getElementById('user-contrato').value = contrato;
        document.getElementById('btn-cancelar').classList.remove('hidden');
    }

    function limparFormulario() {
        editandoId = null;
        document.getElementById('user-id').value = '';
        document.getElementById('user-id').disabled = false;
        document.getElementById('user-nome').value = '';
        document.getElementById('btn-cancelar').classList.add('hidden');
    }

    function logout() {
        localStorage.removeItem('usuario');
        window.location.href = 'index.html';
    }
</script>

</body>
</html>

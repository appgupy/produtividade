<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consolidado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/logo.css">
    
    <style>
        .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:50;}
        .row-total-main td{background-color:#eff6ff!important;font-weight:800;color:var(--primary);}
        .row-sub-header td{background-color:#e2e8f0!important;font-weight:800;color:var(--text-muted);font-size:0.7rem;letter-spacing:1px;padding-top:15px;}
    </style>
</head>
<body>
<div class="container">
    <div class="top-controls">
        <div class="control-group"><label>Visão</label><select id="period-type" onchange="upd()"><option value="mes">Mensal</option><option value="dia">Dia</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano_mes">Anual</option></select></div>
        <div class="control-group" id="grp-yr"><label>Ano</label><select id="year-selector" onchange="upd()"></select></div>
        <div class="control-group" style="flex:1.5"><label>Período</label><select id="period-value" onchange="load()"></select><input type="date" id="date-picker" class="hidden" onchange="load()"></div>
    </div>
    
    <div class="dynamic-panel" style="background:var(--card);padding:20px;border-radius:8px;margin-bottom:20px;border-top:4px solid var(--primary);position:relative;">
        <div class="loading-overlay" id="loading">Carregando...</div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="p-total">0</div></div>
            <div class="stat-card"><div class="stat-label">Média Time</div><div class="stat-value" id="p-media-time">0</div></div>
            <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">Média/Assist (17)</div><div class="stat-value" id="p-media-ind">0</div></div>
            <div class="stat-card"><div class="stat-label">Ativos</div><div class="stat-value" id="p-headcount">0</div></div>
        </div>
    </div>

    <div class="table-wrap" style="position:relative;min-height:200px;">
        <div class="loading-overlay" id="loading-table">Calculando...</div>
        <table id="main-table">
            <thead>
                <tr id="table-header"><th>Indicadores</th></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/logo.js"></script>
<script src="assets/js/layout.js"></script>

<script>
    const HEAD_FIXED=17;
    document.addEventListener('DOMContentLoaded', init);
    
    function init(){ 
        const y=document.getElementById('year-selector'), cy=new Date().getFullYear(); 
        y.innerHTML=''; 
        for(let i=cy; i>=2024; i--) y.innerHTML+=`<option value="${i}">${i}</option>`; 
        upd(); 
    }

    function upd(){ 
        const t=document.getElementById('period-type').value, v=document.getElementById('period-value'), d=document.getElementById('date-picker'), g=document.getElementById('grp-yr');
        v.innerHTML=''; v.classList.remove('hidden'); d.classList.add('hidden'); g.style.visibility='visible';
        
        if(t==='dia'){ 
            v.classList.add('hidden'); d.classList.remove('hidden'); g.style.visibility='hidden'; 
            if(!d.value)d.value=new Date().toISOString().split('T')[0]; 
        }
        else if(t==='mes') ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((m,i)=>v.innerHTML+=`<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`);
        else if(t==='trimestre') v.innerHTML='<option value="1">1º Tri</option><option value="2">2º Tri</option><option value="3">3º Tri</option><option value="4">4º Tri</option>';
        else if(t==='semestre') v.innerHTML='<option value="1">1º Sem</option><option value="2">2º Sem</option>';
        else v.innerHTML='<option value="1">Ano Completo</option>';
        load();
    }

    async function load(){
        const t=document.getElementById('period-type').value, y=document.getElementById('year-selector').value, val=parseInt(document.getElementById('period-value').value);
        let s='', e='';
        
        if(t==='dia') s=e=document.getElementById('date-picker').value;
        else if(t==='mes'){ s=`${y}-${val.toString().padStart(2,'0')}-01`; e=`${y}-${val.toString().padStart(2,'0')}-${new Date(y,val,0).getDate()}`; }
        else if(t==='trimestre'){ const m=((val-1)*3)+1; s=`${y}-${m.toString().padStart(2,'0')}-01`; e=`${y}-${(m+2).toString().padStart(2,'0')}-${new Date(y,m+2,0).getDate()}`; }
        else if(t==='semestre'){ s=val===1?`${y}-01-01`:`${y}-07-01`; e=val===1?`${y}-06-30`:`${y}-12-31`; }
        else { s=`${y}-01-01`; e=`${y}-12-31`; }

        document.getElementById('loading').style.display='flex'; document.getElementById('loading-table').style.display='flex';
        const {data:d}=await _supabase.from('producao').select('*,usuarios(funcao,contrato)').gte('data_referencia',s).lte('data_referencia',e);
        document.getElementById('loading').style.display='none'; document.getElementById('loading-table').style.display='none';
        
        if(!d||!d.length){ 
            ['p-total','p-media-time','p-media-ind','p-headcount'].forEach(x=>document.getElementById(x).innerText='0'); 
            document.getElementById('table-body').innerHTML='<tr><td colspan="20" style="text-align:center">Sem dados</td></tr>'; 
            return; 
        }
        
        let cols=[], numCols=0;
        if(t==='dia') cols=['Dia']; else if(t==='mes') cols=['S1','S2','S3','S4','S5']; else if(t==='trimestre') cols=['M1','M2','M3']; else if(t==='semestre') cols=['M1','M2','M3','M4','M5','M6']; else cols=['Total'];
        numCols=cols.length;

        let st={}; 
        for(let i=1;i<=numCols;i++) st[i]={a:new Set(),ac:new Set(),ap:new Set(),d:new Set(),t:0,tc:0,tp:0,fifo:0,gt:0,gp:0,fc:0}; 
        st[99]={a:new Set(),ac:new Set(),ap:new Set(),d:new Set(),t:0,tc:0,tp:0,fifo:0,gt:0,gp:0,fc:0};

        d.forEach(r=>{
            if(!r.usuarios||r.usuarios.funcao!=='Assistente')return;
            let b=1; const dt=new Date(r.data_referencia+'T12:00:00');
            if(t==='mes') b=Math.ceil((dt.getDate()+new Date(dt.getFullYear(),dt.getMonth(),1).getDay())/7);
            else if(t==='trimestre') b=(dt.getMonth()%3)+1;
            else if(t==='semestre') b=(dt.getMonth()%6)+1;
            
            if(b>numCols) b=numCols;
            [b,99].forEach(k=>{
                const x=st[k]; x.a.add(r.usuario_id); x.d.add(r.data_referencia);
                x.t+=r.quantidade; x.fifo+=r.fifo; x.gt+=r.gradual_total; x.gp+=r.gradual_parcial; x.fc+=r.perfil_fc;
                if(r.usuarios.contrato && r.usuarios.contrato.includes('CLT')){ x.ac.add(r.usuario_id); x.tc+=r.quantidade; }
                else{ x.ap.add(r.usuario_id); x.tp+=r.quantidade; }
            });
        });

        const hRow=document.getElementById('table-header'); 
        hRow.innerHTML='<th>Indicadores</th>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th>Total</th>';
        const idxs=[]; for(let i=1;i<=numCols;i++)idxs.push(i); idxs.push(99);

        const row=(lbl,k,calc,high,main)=>{
            let tr=`<tr class="${high?'row-highlight':''} ${main?'row-total-main':''}"><td>${lbl}</td>`;
            idxs.forEach(i=>{
                const s=st[i], d=s.d.size||1, hReal=s.a.size||1, hFix=HEAD_FIXED, hC=s.ac.size||1, hP=s.ap.size||1;
                let v=0;
                if(!calc){ 
                    if(k==='assist') v=s.a.size; else if(k==='dias') v=s.d.size; else v=s[k]; 
                } else {
                    if(k==='med_dia') v=s.t/d; else if(k==='med_ass') v=s.t/hFix; else if(k==='med_dia_ass') v=s.t/d/hFix;
                    else if(k==='med_clt') v=s.tc/d/hC; else if(k==='med_pj') v=s.tp/d/hP;
                }
                tr+=`<td>${Math.round(v||0).toLocaleString()}</td>`;
            });
            return tr+'</tr>';
        };

        let h='';
        h+=row('Ativos','assist'); h+=row('Dias','dias'); h+=row('FIFO','fifo'); h+=row('G. Parcial','gp'); h+=row('G. Total','gt'); h+=row('Perfil FC','fc');
        h+=row('Total Validados','t',0,0,1); h+=row('Média Diária (Time)','med_dia',1);
        h+=row(`Média/Assist (Base ${HEAD_FIXED})`,'med_ass',1); h+=row(`Média Diária/Assist (Base ${HEAD_FIXED})`,'med_dia_ass',1,1);
        h+=`<tr class="row-sub-header"><td colspan="${numCols+2}">CLT</td></tr>` + row('Produção','tc') + row('Média Diária/Pessoa','med_clt',1);
        h+=`<tr class="row-sub-header"><td colspan="${numCols+2}">PJ</td></tr>` + row('Produção','tp') + row('Média Diária/Pessoa','med_pj',1);
        
        document.getElementById('table-body').innerHTML=h;
        const tot=st[99]; const dt=tot.d.size||1;
        document.getElementById('p-total').innerText=tot.t.toLocaleString();
        document.getElementById('p-media-time').innerText=Math.round(tot.t/dt).toLocaleString();
        document.getElementById('p-media-ind').innerText=Math.round(tot.t/dt/HEAD_FIXED).toLocaleString();
        document.getElementById('p-headcount').innerText=tot.a.size;
    }
</script>
</body>
</html>
